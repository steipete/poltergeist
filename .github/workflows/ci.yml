name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cli-test:
    name: CLI Tests - Node ${{ matrix.node-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    env:
      POLTERGEIST_TEST_MODE: 'true'
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-15]
        node-version: ['22', '24']
        
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v6
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: Enable pnpm
      run: corepack enable pnpm
      
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build CLI project
      run: pnpm run build
      
    - name: Run linter
      run: pnpm run lint
      
    - name: Run TypeScript type check
      run: pnpm run typecheck
      
    - name: Run CLI tests
      run: |
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          pnpm vitest --config vitest.config.windows-ci.ts
        else
          pnpm vitest --config vitest.config.ci.ts
        fi
      shell: bash
      
    - name: Test CLI executables
      run: |
        node dist/cli.js --version
        node dist/polter.js --help || true  # polter may exit with error code when no args
      shell: bash
      
  format-check:
    name: Code Format Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        
    - name: Enable pnpm
      run: corepack enable pnpm
      
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Check code formatting
      run: pnpm run format:check
      
  windows-specific:
    name: Windows-specific Tests
    runs-on: windows-latest
    env:
      POLTERGEIST_TEST_MODE: 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        
    - name: Enable pnpm
      run: corepack enable pnpm
      
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build CLI project
      run: pnpm run build
      
    - name: Test Windows temp directory handling
      run: |
        node -e "
          const { FileSystemUtils } = require('./dist/utils/filesystem.js');
          const path = FileSystemUtils.getStateDirectory();
          console.log('Windows state directory:', path);
          const normalized = path.toLowerCase();
          const isTempPath = normalized.includes('temp') || normalized.includes('tmp');
          const isAppDataPath = normalized.includes('poltergeist\\state') || normalized.includes('poltergeist/state');
          if (!isTempPath && !isAppDataPath) {
            throw new Error('Expected Windows temp or appdata state directory');
          }
          console.log('✅ Windows temp directory test passed');
        "
      
    - name: Test cross-platform path operations
      run: |
        node -e "
          const { FileSystemUtils } = require('./dist/utils/filesystem.js');
          const filename = FileSystemUtils.generateStateFileName('C:\\\\Users\\\\test\\\\project', 'debug');
          console.log('Generated filename:', filename);
          if (!filename.includes('project-') || !filename.includes('-debug.state')) {
            throw new Error('Filename generation failed');
          }
          console.log('✅ Cross-platform path test passed');
        "
        
    - name: Test process management on Windows
      run: |
        node -e "
          const { ProcessManager } = require('./dist/utils/process-manager.js');
          console.log('✅ ProcessManager loads correctly on Windows');
        "

  macos-app:
    name: macOS App - Swift 6 Build & Test
    runs-on: macos-15
    env:
      POLTERGEIST_TEST_MODE: 'true'
    continue-on-error: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        # Pin to stable Xcode to avoid actool crashes on macos-15 when "latest" selects RC builds
        xcode-version: '16.4'
        
    - name: Install SwiftLint and swift-format
      run: |
        brew install swiftlint swift-format
        
    - name: Build macOS app
      run: |
        cd apps/mac
        xcodebuild -project Poltergeist.xcodeproj -scheme Poltergeist -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
        
    - name: Run SwiftLint
      run: |
        cd apps/mac
        ./scripts/lint.sh
        
    - name: Run swift-format check
      run: |
        cd apps/mac
        ./scripts/format.sh
        git diff --exit-code || (echo "Swift code is not formatted. Please run './scripts/format.sh' locally." && exit 1)
        
    - name: Validate Swift Testing tests
      run: |
        cd apps/mac
        ./scripts/test.sh
        
    - name: Run Swift Testing tests (if main app builds)
      timeout-minutes: 5
      run: |
        cd apps/mac
        # First try to build the main app, then run tests if successful
        if xcodebuild -project Poltergeist.xcodeproj -scheme Poltergeist -configuration Debug build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO -quiet; then
          echo "✅ Main app builds successfully, running tests..."
          timeout 180 xcodebuild test -project Poltergeist.xcodeproj -scheme PoltergeistTests -destination 'platform=macOS,arch=arm64' CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO -quiet || echo "⚠️  Tests had issues but test target is configured correctly"
        else
          echo "⚠️  Main app has build issues, skipping test execution"
        fi
        
